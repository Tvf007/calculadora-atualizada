<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Sistema de Caixa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    body {
      font-family: Arial;
      padding: 15px;
      background: #f4f4f4;
      margin: 0;
      min-height: 100vh;
    }

    .produto {
      margin-bottom: 12px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-size: 16px;
    }

    input[type="text"] {
      width: 100%;
      max-width: 100px;
      padding: 5px;
      font-size: 16px;
    }

    ul {
      list-style-type: none;
      padding-left: 0;
    }

    li {
      background: #fff;
      margin: 3px 0;
      padding: 6px;
      border-radius: 4px;
      font-size: 14px;
    }

    #notaFiscal,
    #historicoNotas {
      background: #fff;
      padding: 12px;
      margin-top: 15px;
      border-radius: 6px;
    }

    .nota-item {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
    }

    .nota-header {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 14px;
    }

    #mensagemValidacao {
      color: red;
      margin-top: 10px;
      font-size: 14px;
    }

    /* Estilo do teclado numérico */
    .teclado-numerico {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      border: 1px solid #ccc;
      background: #f9f9f9;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      max-width: 90vw;
      width: 90vw;
      cursor: move;
      user-select: none;
    }

    .fechar-teclado-btn {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 28px;
      height: 28px;
      background-color: red;
      color: white;
      font-size: 18px;
      text-align: center;
      line-height: 26px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      z-index: 1001;
    }

    .teclado-numerico h3 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 16px;
      cursor: default;
    }

    .teclado-numerico button {
      width: 25%;
      height: 50px;
      margin: 3px;
      font-size: 20px;
      cursor: pointer;
      border: 1px solid #aaa;
      border-radius: 5px;
      background-color: #fff;
      flex: 0 0 30%;
    }

    .teclado-numerico button:hover {
      background-color: #e0e0e0;
    }

    .teclado-numerico .enter {
      background-color: #28a745;
      color: white;
    }

    .teclado-numerico .backspace {
      background-color: #dc3545;
      color: white;
    }

    @media (max-width: 600px) {
      .teclado-numerico button {
        width: 30%;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>

<h1>Sistema de Caixa</h1>

<div class="produto">
  <label>Pão Francês (R$ 0,70):</label>
  <input type="text" id="quantidadePaoFrances" readonly onclick="abrirTeclado(this)">
  <span id="resultadoPaoFrances">R$ 0,00</span>
</div>

<div class="produto">
  <label>Pão Doce Comum (R$ 0,70):</label>
  <input type="text" id="quantidadePaoDoceComum" readonly onclick="abrirTeclado(this)">
  <span id="resultadoPaoDoceComum">R$ 0,00</span>
</div>

<div class="produto">
  <label>Pão Doce Especial (R$ 0,80):</label>
  <input type="text" id="quantidadePaoDoceEspecial" readonly onclick="abrirTeclado(this)">
  <span id="resultadoPaoDoceEspecial">R$ 0,00</span>
</div>

<div class="produto">
  <label>Outro Produto (R$):</label>
  <input type="text" id="valorEntrada" placeholder="Digite valor" readonly onclick="abrirTeclado(this)">
  <span id="resultadoAcumulado">R$ 0,00</span>
</div>

<div id="notaFiscal">
  <h2>Nota Fiscal</h2>
  <ul id="listaItens"></ul>
  <p><strong>Total:</strong> <span id="valorTotal">R$ 0,00</span></p>
  <p><strong>Recebido:</strong>
    <input type="text" id="valorRecebido" readonly onclick="abrirTeclado(this)">
  </p>
  <p><strong>Troco:</strong> <span id="valorTroco">R$ 0,00</span></p>

  <!-- Campos ocultos para histórico -->
  <p style="display:none"><span id="nfTotal">R$ 0,00</span></p>
  <p style="display:none"><span id="nfRecebido">R$ 0,00</span></p>
  <p style="display:none"><span id="nfTroco">R$ 0,00</span></p>

  <button onclick="proximoCliente()">Finalizar Venda</button>
</div>

<div id="historicoNotas"></div>

<!-- Teclado Numérico -->
<div class="teclado-numerico" id="tecladoNumerico">
  <div class="fechar-teclado-btn" onclick="fecharTeclado()" title="Fechar">×</div>
  <h3>Teclado Virtual</h3>
  <div id="botoesTeclado" style="display:flex; flex-wrap:wrap; justify-content:center;"></div>
</div>

<script>
  const botoes = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '.', '0', '⌫', 'Enter'];
  const botoesDiv = document.getElementById('botoesTeclado');

  botoes.forEach(btn => {
    const b = document.createElement('button');
    b.textContent = btn;

    if (btn === 'Enter') b.classList.add('enter');
    else if (btn === '⌫') b.classList.add('backspace');
    else b.classList.add('normal');

    b.onclick = () => digitarTeclado(btn);
    botoesDiv.appendChild(b);
  });

  let numeroNota = 1;
  let historico = [];
  let totalAcumulado = 0;
  let produtosAdicionais = [];
  let campoFocado = null;

  function formatar(valor) {
    return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function atualizarNota(nome, qtd, valorUnitario, subtotal) {
    const lista = document.getElementById('listaItens');
    const id = `item-${nome.toLowerCase().replace(/\s+/g, '-')}`;

    if (qtd <= 0) {
      const existente = document.getElementById(id);
      if (existente) lista.removeChild(existente);
      return;
    }

    const linha = `${nome} x${qtd} = ${formatar(subtotal)} (${formatar(valorUnitario)})`;

    let li = document.getElementById(id);
    if (!li) {
      li = document.createElement('li');
      li.id = id;
      lista.appendChild(li);
    }
    li.textContent = linha;
  }

  function criarCalculadora(inputId, resultadoId, precoUnitario, nomeProduto) {
    const input = document.getElementById(inputId);
    const resultado = document.getElementById(resultadoId);

    function calcular() {
      let qtd = parseInt(input.value) || 0;
      let subtotal = qtd * precoUnitario;
      resultado.textContent = formatar(subtotal);
      atualizarNota(nomeProduto, qtd, precoUnitario, subtotal);
      atualizarTotalGeral();
    }

    input.addEventListener('input', calcular);
    calcular(); // Calcula inicial
  }

  criarCalculadora('quantidadePaoFrances', 'resultadoPaoFrances', 0.70, 'Pão Francês');
  criarCalculadora('quantidadePaoDoceComum', 'resultadoPaoDoceComum', 0.70, 'Pão Doce Comum');
  criarCalculadora('quantidadePaoDoceEspecial', 'resultadoPaoDoceEspecial', 0.80, 'Pão Doce Especial');

  function abrirTeclado(campo) {
    campoFocado = campo;
    const teclado = document.getElementById('tecladoNumerico');
    teclado.style.display = 'block';
    dragElement(teclado); // Ativa arraste
  }

  function digitarTeclado(valor) {
    if (valor === 'Enter') {
      if (campoFocado.id === 'valorEntrada') adicionarOutroProduto();
      else if (campoFocado.id === 'valorRecebido') atualizarTroco();
      return;
    }

    if (valor === '⌫') {
      limparCampo();
      return;
    }

    if (campoFocado) {
      campoFocado.value += valor;
      const event = new Event('input', { bubbles: true });
      campoFocado.dispatchEvent(event);
    }
  }

  function limparCampo() {
    if (campoFocado) {
      campoFocado.value = '';
      const event = new Event('input', { bubbles: true });
      campoFocado.dispatchEvent(event);
    }
  }

  function fecharTeclado() {
    document.getElementById('tecladoNumerico').style.display = 'none';
    campoFocado = null;
  }

  function adicionarOutroProduto() {
    let valorTexto = document.getElementById('valorEntrada').value.replace(',', '.');
    let valor = parseFloat(valorTexto);

    if (!isNaN(valor) && valor > 0) {
      const nome = 'Outro Produto';
      const id = `item-outrosprodutos-${produtosAdicionais.length + 1}`;

      const novoItem = {
        id: id,
        texto: `${nome} - ${formatar(valor)}`
      };

      produtosAdicionais.push(novoItem);
      totalAcumulado += valor;

      const lista = document.getElementById('listaItens');
      const li = document.createElement('li');
      li.id = id;
      li.textContent = novoItem.texto;
      lista.appendChild(li);

      document.getElementById('resultadoAcumulado').textContent = formatar(totalAcumulado);
      document.getElementById('valorEntrada').value = '';
      atualizarTotalGeral();
    }
  }

  function atualizarTotalGeral() {
    const paoFrances = parseInt(document.getElementById('quantidadePaoFrances').value) || 0;
    const paoDoceComum = parseInt(document.getElementById('quantidadePaoDoceComum').value) || 0;
    const paoDoceEspecial = parseInt(document.getElementById('quantidadePaoDoceEspecial').value) || 0;

    const total =
      paoFrances * 0.70 +
      paoDoceComum * 0.70 +
      paoDoceEspecial * 0.80 +
      totalAcumulado;

    document.getElementById('valorTotal').textContent = formatar(total);
    document.getElementById('nfTotal').textContent = formatar(total);
    atualizarTroco();
  }

  function atualizarTroco() {
    const total = parseFloat(document.getElementById('valorTotal').textContent.replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
    const recebido = parseFloat(document.getElementById('valorRecebido').value.replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
    const troco = recebido - total;

    document.getElementById('valorTroco').textContent = troco >= 0 ? formatar(troco) : 'Falta pagar';
    document.getElementById('nfRecebido').textContent = formatar(recebido);
    document.getElementById('nfTroco').textContent = troco >= 0 ? formatar(troco) : 'Falta pagar';
  }

  function proximoCliente() {
    const total = parseFloat(document.getElementById('valorTotal').textContent.replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
    const recebidoTexto = document.getElementById('valorRecebido').value.trim().replace(',', '.');
    const recebido = parseFloat(recebidoTexto) || 0;

    const msgElemento = document.getElementById('mensagemValidacao');

    if (recebidoTexto === '') {
      if (!msgElemento) {
        const divMsg = document.createElement('div');
        divMsg.id = 'mensagemValidacao';
        divMsg.style.color = 'red';
        divMsg.style.marginTop = '10px';
        divMsg.textContent = 'Falta preencher valor recebido';
        document.querySelector('#notaFiscal button').before(divMsg);
      } else {
        msgElemento.textContent = 'Falta preencher valor recebido';
      }
      return;
    }

    if (recebido < total) {
      if (!msgElemento) {
        const divMsg = document.createElement('div');
        divMsg.id = 'mensagemValidacao';
        divMsg.style.color = 'red';
        divMsg.style.marginTop = '10px';
        divMsg.textContent = 'Valor insuficiente';
        document.querySelector('#notaFiscal button').before(divMsg);
      } else {
        msgElemento.textContent = 'Valor insuficiente';
      }
      return;
    }

    if (msgElemento) msgElemento.remove();

    const itens = Array.from(document.getElementById('listaItens').children).map(li => li.textContent);
    const data = new Date().toLocaleString();

    historico.push({
      numero: numeroNota++,
      itens,
      total: document.getElementById('nfTotal').textContent,
      recebido: document.getElementById('nfRecebido').textContent,
      troco: document.getElementById('nfTroco').textContent,
      data
    });

    document.getElementById('quantidadePaoFrances').value = '';
    document.getElementById('quantidadePaoDoceComum').value = '';
    document.getElementById('quantidadePaoDoceEspecial').value = '';
    document.getElementById('valorEntrada').value = '';
    document.getElementById('resultadoPaoFrances').textContent = 'R$ 0,00';
    document.getElementById('resultadoPaoDoceComum').textContent = 'R$ 0,00';
    document.getElementById('resultadoPaoDoceEspecial').textContent = 'R$ 0,00';
    document.getElementById('resultadoAcumulado').textContent = 'R$ 0,00';
    document.getElementById('listaItens').innerHTML = '';
    document.getElementById('valorTotal').textContent = 'R$ 0,00';
    document.getElementById('valorRecebido').value = '';
    document.getElementById('valorTroco').textContent = 'R$ 0,00';
    document.getElementById('nfTotal').textContent = 'R$ 0,00';
    document.getElementById('nfRecebido').textContent = 'R$ 0,00';
    document.getElementById('nfTroco').textContent = 'R$ 0,00';

    totalAcumulado = 0;
    produtosAdicionais = [];

    renderizarHistorico();
  }

  function renderizarHistorico() {
    const container = document.getElementById('historicoNotas');
    container.innerHTML = '<h2>Histórico de Vendas</h2>';
    historico.forEach(nota => {
      const div = document.createElement('div');
      div.className = 'nota-item';
      div.innerHTML = `
        <div class="nota-header">Nota #${nota.numero} - ${nota.data}</div>
        <ul>${nota.itens.map(item => `<li>${item}</li>`).join('')}</ul>
        <div>Total: ${nota.total}</div>
        <div>Recebido: ${nota.recebido}</div>
        <div>Troco: ${nota.troco}</div>
      `;
      container.appendChild(div);
    });
  }

  function dragElement(element) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

    element.onmousedown = dragMouseDown;

    function dragMouseDown(e) {
      e = e || window.event;
      e.preventDefault();
      pos3 = e.clientX;
      pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
      e = e || window.event;
      e.preventDefault();
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      element.style.top = (element.offsetTop - pos2) + 'px';
      element.style.left = (element.offsetLeft - pos1) + 'px';
    }

    function closeDragElement() {
      document.onmouseup = null;
      document.onmousemove = null;
    }

    // Adiciona suporte a toque
    let touchDown = false;

    element.ontouchstart = function(e) {
      touchDown = true;
      const t = e.touches[0];
      pos3 = t.clientX;
      pos4 = t.clientY;
      document.ontouchend = closeTouchElement;
      document.ontouchmove = touchMove;
    }

    function touchMove(e) {
      if (!touchDown) return;
      const t = e.touches[0];
      pos1 = pos3 - t.clientX;
      pos2 = pos4 - t.clientY;
      pos3 = t.clientX;
      pos4 = t.clientY;
      element.style.top = (element.offsetTop - pos2) + 'px';
      element.style.left = (element.offsetLeft - pos1) + 'px';
    }

    function closeTouchElement() {
      touchDown = false;
      document.ontouchmove = null;
      document.ontouchend = null;
    }
  }

  document.getElementById('valorRecebido').addEventListener('input', function () {
    const msg = document.getElementById('mensagemValidacao');
    if (msg) msg.remove();
  });

  document.getElementById('valorEntrada').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') adicionarOutroProduto();
  });

  function registrarServiceWorker() {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log('✅ Service Worker Registrado'))
        .catch(err => console.error('❌ Erro ao Registrar SW:', err));
    }
  }

  window.onload = () => {
    registrarServiceWorker();
  };
</script>

</body>
</html>